<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sudoku Solver & Game</title>
    <style>
      :root {
        /* Modern Blue Theme (Light) */
        --bg: #f4f7f6;
        --panel: #ffffff;
        --sidebar-bg: #ffffff;
        --text: #1a2533;
        --accent: #0059b3;
        --accent-soft: #007bff;
        --border-thick: #00448a;
        --border-medium: #007bff;
        --border-thin: #d8e1e8;
        --cell-bg: #ffffff;
        --btn-primary: #0059b3;
        --btn-primary-hover: #00448a;
        --btn-secondary: #5a6b7d;
        --btn-secondary-hover: #42505e;
        --cell-trying-bg: #e0f0ff;
        --cell-backtrack-bg: #fff8e0;
        --cell-invalid-bg: #ffe0e0;
        --cell-active-bg: #dcedff;
        --cell-peer-bg: #f0f4f8;
        --toast-bg: #1a2533;
        --toast-text: #ffffff;
      }

      body.dark {
        /* Modern Blue Theme (Dark) */
        --bg: #121a22;
        --panel: #1a2430;
        --sidebar-bg: #16202a;
        --text: #e1e9f2;
        --accent: #0095ff;
        --accent-soft: #38abff;
        --border-thick: #0095ff;
        --border-medium: #007bff;
        --border-thin: #2c3a4a;
        --cell-bg: #1a2430;
        --btn-primary: #007bff;
        --btn-primary-hover: #006ae0;
        --btn-secondary: #3e4d5e;
        --btn-secondary-hover: #4f637a;
        --cell-trying-bg: #2a4a6c;
        --cell-backtrack-bg: #6c5a2a;
        --cell-invalid-bg: #6c2a2a;
        --cell-active-bg: #2a5a8c;
        --cell-peer-bg: #233140;
        --toast-bg: #e1e9f2;
        --toast-text: #121a22;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        height: 100%;
      }

      body {
        font-family: "Poppins", system-ui, Segoe UI, Arial;
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: background 0.3s, color 0.3s;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: var(--panel);
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid var(--border-thin);
        z-index: 100;
        flex-shrink: 0;
      }

      .brand {
        font-weight: 700;
        font-size: 22px;
        color: var(--accent);
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      #userInfo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 15px;
      }
      #logoutBtn {
        all: unset;
        cursor: pointer;
        font-weight: 600;
        color: var(--btn-secondary);
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 6px;
        transition: background 0.2s, color 0.2s;
      }
      #logoutBtn:hover {
        background: var(--btn-secondary-hover);
        color: #fff;
      }
      body.dark #logoutBtn {
        color: var(--text);
        opacity: 0.7;
      }
      body.dark #logoutBtn:hover {
        background: var(--btn-secondary-hover);
        color: var(--text);
        opacity: 1;
      }

      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 15px;
        transition: background 0.2s, transform 0.1s;
        width: 100%;
      }
      .btn:disabled {
        background: var(--btn-secondary-hover);
        cursor: not-allowed;
        opacity: 0.7;
      }
      .btn.primary {
        background: var(--btn-primary);
        color: #fff;
      }
      .btn.primary:hover:not(:disabled) {
        background: var(--btn-primary-hover);
      }
      .btn.secondary {
        background: var(--btn-secondary);
        color: #fff;
      }
      .btn.secondary:hover:not(:disabled) {
        background: var(--btn-secondary-hover);
      }
      .btn:active {
        transform: scale(0.98);
      }
      
      .app-layout {
        flex: 1 1 auto;
        display: none;
        min-height: 0;
      }
      body.loggedIn .app-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas:
          "sidebar puzzle"
          "sidebar submission"
          "sidebar footer-area";
        gap: 0 24px;
        padding: 24px;
      }
      
      .sidebar {
        grid-area: sidebar;
        background: var(--sidebar-bg);
        padding: 24px;
        border: 1px solid var(--border-thin);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow-y: auto;
        border-radius: 12px;
      }

      .sidebar-panel {
        background: var(--panel);
        border: 1px solid var(--border-thin);
        border-radius: 12px;
        padding: 20px;
      }
      .sidebar-panel h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-thin);
      }
      
      main {
        grid-area: puzzle;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      section.puzzle-area {
        background: var(--panel);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-thin);
        width: auto;
      }

      .grid-wrapper {
        background: var(--border-thick);
        padding: 4px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(9, 44px);
        grid-template-rows: repeat(9, 44px);
        background: var(--border-thick);
      }

      #timerDisplay {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
        text-align: center;
        margin-top: 16px;
        font-family: monospace;
      }

      .cell {
        width: 44px;
        height: 44px;
        text-align: center;
        font-size: 18px;
        border: 1px solid var(--border-thin);
        background: var(--cell-bg);
        color: var(--text);
        outline: none;
        transition: background 0.1s, color 0.1s, border-color 0.1s;
      }

      .cell:nth-child(-n + 9) {
        border-top: 3px solid var(--border-thick);
      }
      .cell:nth-child(9n + 1) {
        border-left: 3px solid var(--border-thick);
      }
      .cell:nth-child(9n) {
        border-right: 3px solid var(--border-thick);
      }
      .cell:nth-child(n + 73) {
        border-bottom: 3px solid var(--border-thick);
      }
      .cell:nth-child(3n) {
        border-right: 2px solid var(--border-medium);
      }
      .cell:nth-child(n + 19):nth-child(-n + 27),
      .cell:nth-child(n + 46):nth-child(-n + 54) {
        border-bottom: 2px solid var(--border-medium);
      }

      .cell:focus {
        border-color: var(--accent-soft);
      }
      .cell.original {
        font-weight: 700;
      }
      .cell.original[readonly] {
        background: var(--panel);
      }
      .cell.solved {
        color: var(--accent);
      }

      .cell.trying {
        background: var(--cell-trying-bg);
      }
      .cell.backtrack {
        background: var(--cell-backtrack-bg);
      }
      .cell.invalid {
        background: var(--cell-invalid-bg);
      }

      .cell.highlight-peer {
        background: var(--cell-peer-bg);
      }
      .cell.highlight-active {
        background: var(--cell-active-bg);
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .control-group label {
        font-weight: 500;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .control-group .btn-group {
        display: flex;
        gap: 10px;
      }
      .btn-group .btn {
        flex: 1;
      }


      select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-thin);
        background: var(--bg);
        color: var(--text);
        font-size: 15px;
        width: 100%;
      }

      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translate(-50%, 100%);
        background: var(--toast-bg);
        color: var(--toast-text);
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
        opacity: 0;
        visibility: hidden;
        transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s;
        z-index: 1000;
      }
      #toast.show {
        transform: translate(-50%, 0);
        opacity: 1;
        visibility: visible;
      }

      .submission-card {
        grid-area: submission;
        text-align: center;
        padding: 24px 40px;
        border-radius: 12px;
        background: var(--panel);
        box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-thin);
        margin-top: 24px;
      }
      .submission-card h2 {
        color: var(--accent);
        font-size: 24px;
        margin-bottom: 8px;
      }
      .submission-card p {
        font-size: 17px;
        line-height: 1.6;
        color: var(--text);
      }

      footer {
        grid-area: footer-area;
        font-size: 14px;
        padding: 24px;
        background: var(--panel);
        border: 1px solid var(--border-thin);
        border-radius: 12px;
        margin-top: 24px;
      }
      
      .footer-grid {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }
      .stats-list {
        list-style: none;
        padding: 0;
      }
      .stats-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 4px;
        font-size: 15px;
        border-bottom: 1px solid var(--border-thin);
      }
      .stats-list li:last-child {
        border-bottom: none;
      }
      .stats-list span {
        font-weight: 600;
        color: var(--accent);
        font-size: 16px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 6px;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid var(--border-thin);
        padding: 6px 10px;
        text-align: left;
      }
      thead {
        background: var(--accent-soft);
        color: #fff;
      }
      body.dark thead {
        color: var(--text);
      }

      @media (max-width: 930px) {
        body.loggedIn .app-layout {
          display: flex;
          flex-direction: column;
          padding: 16px;
          gap: 16px;
        }
        
        main {
          order: 1;
        }
        
        .sidebar {
          order: 2;
          width: 100%;
          border-right: none;
          padding: 16px;
          flex-direction: column;
          gap: 16px;
        }
        .sidebar-panel {
          flex: 1;
          min-width: 0;
        }

        .submission-card {
          order: 3;
          width: 100%;
          margin-top: 0;
          padding: 20px;
        }
        
        footer {
          order: 4;
          width: 100%;
          margin-top: 0;
          padding: 16px;
        }

        section.puzzle-area {
          margin: 0 auto;
          transform: scale(0.95);
        }
      }
      
      #confetti {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
      }
      #themeBtn {
        all: unset;
        cursor: pointer;
        padding: 8px 18px;
        border-radius: 8px;
        border: 2px solid var(--accent);
        background: var(--panel);
        color: var(--accent);
        font-size: 15px;
        font-weight: 600;
        transition: background 0.25s ease, color 0.25s ease,
          border-color 0.25s ease, transform 0.1s;
        user-select: none;
      }
      #themeBtn:hover {
        background: var(--accent);
        color: var(--panel);
      }
      #themeBtn:active {
        transform: scale(0.97);
      }
      body.dark #themeBtn {
        border-color: var(--accent-soft);
        color: var(--accent-soft);
        background: var(--panel);
      }
      body.dark #themeBtn:hover {
        background: var(--accent-soft);
        color: #000;
      }

      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      body.loggedIn #loginModal {
        display: none;
      }
      .login-box {
        background: var(--panel);
        padding: 32px 40px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      .login-box h2 {
        font-size: 22px;
        color: var(--accent);
        margin-bottom: 20px;
      }
      #usernameInput {
        font-size: 16px;
        padding: 12px 14px;
        border-radius: 8px;
        border: 1px solid var(--border-thin);
        width: 300px;
        margin-bottom: 20px;
        background: var(--bg);
        color: var(--text);
      }
      #loginBtn {
        width: 100%;
        min-width: 300px;
      }
    </style>
  </head>

  <body>
    <div id="loginModal">
      <div class="login-box">
        <h2>Welcome to Sudoku!</h2>
        <input
          type="text"
          id="usernameInput"
          placeholder="Enter your name to play"
        />
        <button class="btn primary" id="loginBtn">Login & Play</button>
      </div>
    </div>

    <header>
      <div class="brand">Sudoku Solver & Game</div>
      <div class="header-controls">
        <div id="userInfo" style="display: none">
          <span id="welcomeMsg"></span>
          <button id="logoutBtn">Logout</button>
        </div>
        <button class="btn primary" id="themeBtn" title="Toggle Theme" style="display: none">
          ðŸŒ™
        </button>
      </div>
    </header>

    <div class="app-layout">
      <aside class="sidebar">
        <div class="sidebar-panel">
          <h2>Game Controls</h2>
          <div class="controls">
            <div class="control-group">
              <label for="difficulty">Difficulty:</label>
              <select id="difficulty">
                <option value="easy">Easy (more clues)</option>
                <option value="medium" selected>Medium (balanced)</option>
                <option value="hard">Hard (fewer clues)</option>
              </select>
            </div>
            
            <div class="control-group">
              <button class="btn primary" id="generateBtn">
                Generate Puzzle
              </button>
            </div>
            
            <div class="control-group">
               <label for="speed">Solver Speed:</label>
                <select id="speed">
                    <option value="slow">Slow (Step-by-step)</option>
                    <option value="normal" selected>Normal (Balanced)</option>
                    <option value="fast">Fast (Quick solve)</option>
                </select>
               <div class="btn-group">
                  <button class="btn primary" id="solveBtn">Solve (Visual)</button>
                  <button class="btn primary" id="skipBtn">Skip</button>
               </div>
            </div>

            <div class="control-group">
               <div class="btn-group">
                    <button class="btn secondary" id="resetBtn">Reset</button>
                    <button class="btn secondary" id="stopBtn">Stop</button>
               </div>
            </div>
          </div>
        </div>
        
        <div class="sidebar-panel">
            <h2>Your Best Times</h2>
            <ul class="stats-list">
                <li>Easy: <span id="bestEasy">N/A</span></li>
                <li>Medium: <span id="bestMedium">N/A</span></li>
                <li>Hard: <span id="bestHard">N/A</span></li>
            </ul>
        </div>
      </aside>

      <main>
        <section class="puzzle-area">
          <div class="grid-wrapper">
            <div class="grid" id="grid"></div>
          </div>
          <div id="timerDisplay">00:00</div>
        </section>
      </main>
      
      <div class="submission-card">
        <h2>Project Submission</h2>
        <p><strong>Project:</strong> Sudoku Solver (PBL)</p>
        <p>
          <strong>Submitted To:</strong> Er. Manish Dwivedi, Associate Professor
        </p>
        <p><strong>Department:</strong> Computer Science and Engineering</p>
        <p><strong>Institution:</strong> Arya College of Engineering and IT</p>
      </div>

      <footer>
        <div class="footer-grid">
          <div style="flex: 2 1 300px; max-width: 600px;">
            <strong>Team Members</strong>
            <table>
              <thead>
                <tr>
                  <th>Sr. No.</th>
                  <th>Name</th>
                  <th>RTU Roll No.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>Mayank Jangid</td>
                  <td>24EARAD097</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>Mohit Kumar Sharma</td>
                  <td>24EARAD103</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>Palak Agarwal</td>
                  <td>24EARAD115</td>
                </tr>
                <tr>
                  <td>4</td>
                  <td>Prabhash Kumar Choudhary</td>
                  <td>24EARAD121</td>
                </tr>
                <tr>
                  <td>5</td>
                  <td>Prashant Jain</td>
                  <td>24EARAD124</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </footer>
    </div>

    <div id="toast"></div>

    <canvas id="confetti"></canvas>

    <script>
      const GRID = document.getElementById("grid"),
        cells = [],
        speedMap = { slow: 300, normal: 80, fast: 20 };
      let stopViz = false,
        original = Array.from({ length: 9 }, () => Array(9).fill(false));

      let toastTimeout = null;

      let currentUser = null;
      let allUsers = {};
      let userData = { bestTimes: { easy: null, medium: null, hard: null } };
      let timerInterval = null;
      let secondsElapsed = 0;
      let currentDifficulty = "medium";

      for (let i = 0; i < 81; i++) {
        const inp = document.createElement("input");
        inp.className = "cell";
        inp.maxLength = 1;
        inp.inputMode = "numeric";

        const r = Math.floor(i / 9);
        const c = i % 9;

        inp.addEventListener("input", () => {
          inp.value = inp.value.replace(/[^1-9]/g, "");
          checkManualWin();
        });

        inp.addEventListener("focus", () => {
          highlightPeers(r, c);
        });
        inp.addEventListener("blur", () => {
          highlightPeers(-1, -1);
        });

        GRID.appendChild(inp);
        cells.push(inp);
      }

      function deepCopy(b) {
        return b.map((r) => r.slice());
      }
      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");

        if (toastTimeout) clearTimeout(toastTimeout);

        toastTimeout = setTimeout(() => {
          toast.classList.remove("show");
          toastTimeout = null;
        }, 3000);
      }

      function validPlacement(b, r, c, n) {
        for (let i = 0; i < 9; i++)
          if ((b[r][i] === n && i !== c) || (b[i][c] === n && i !== r))
            return false;
        const sr = r - (r % 3),
          sc = c - (c % 3);
        for (let i = 0; i < 3; i++)
          for (let j = 0; j < 3; j++)
            if (b[sr + i][sc + j] === n && (sr + i !== r || sc + j !== c))
              return false;
        return true;
      }
       
      function solveRandomized(board) {
        const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        for (let r = 0; r < 9; r++) {
          for (let c = 0; c < 9; c++) {
            if (board[r][c] === 0) {
              for (let i = nums.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nums[i], nums[j]] = [nums[j], nums[i]];
              }
              for (const n of nums) {
                if (validPlacement(board, r, c, n)) {
                  board[r][c] = n;
                  if (solveRandomized(board)) return true;
                  board[r][c] = 0;
                }
              }
              return false;
            }
          }
        }
        return true;
      }

      function countSolutions(board, limit = 2) {
        let count = 0;
        function solve() {
          if (count >= limit) return;
          for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
              if (board[r][c] === 0) {
                for (let n = 1; n <= 9; n++) {
                  if (validPlacement(board, r, c, n)) {
                    board[r][c] = n;
                    solve();
                    board[r][c] = 0;
                    if (count >= limit) return;
                  }
                }
                return;
              }
            }
          }
          count++;
        }
        solve();
        return count;
      }

      async function generatePuzzle(diff) {
        const removeCount = diff === "easy" ? 36 : diff === "medium" ? 46 : 54;
        let board = Array.from({ length: 9 }, () => Array(9).fill(0));
        solveRandomized(board);
        const positions = Array.from({ length: 81 }, (_, i) => i);
        for (let i = positions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        let removed = 0;
        for (const pos of positions) {
          if (removed >= removeCount) break;
          const r = Math.floor(pos / 9);
          const c = pos % 9;
          const backup = board[r][c];
          board[r][c] = 0;
          const solutions = countSolutions(deepCopy(board), 2);
          if (solutions === 1) {
            removed++;
          } else {
            board[r][c] = backup;
          }
        }
        return board;
      }

      function readUI() {
        const b = Array.from({ length: 9 }, () => Array(9).fill(0));
        for (let r = 0; r < 9; r++)
          for (let c = 0; c < 9; c++) {
            const v = cells[r * 9 + c].value;
            b[r][c] = v ? +v : 0;
          }
        return b;
      }

      function loadUI(b) {
        stopTimer(); 
        document.getElementById("timerDisplay").textContent = "00:00"; 
        if (!b || b.length === 0) {
          for (const el of cells) {
            el.value = "";
            el.className = "cell";
            el.readOnly = false;
          }
          original = Array.from({ length: 9 }, () => Array(9).fill(false));
          return;
        }
        for (let r = 0; r < 9; r++)
          for (let c = 0; c < 9; c++) {
            const v = b[r][c],
              el = cells[r * 9 + c];
            el.value = v || "";
            original[r][c] = !!v;
            el.className = "cell" + (v ? " original" : "");
            el.readOnly = !!v;
          }
      }

      function clearMarks() {
        for (const el of cells)
          el.classList.remove("trying", "backtrack", "invalid");
      }

      function validate(b) {
        clearMarks();
        let ok = true;
        for (let r = 0; r < 9; r++)
          for (let c = 0; c < 9; c++)
            if (b[r][c] && !validPlacement(b, r, c, b[r][c])) {
              cells[r * 9 + c].classList.add("invalid");
              ok = false;
            }
        if (!ok) showToast("Invalid Sudoku: Check red cells.");
        return ok;
      }
      
      function isBoardValidAndFull(b) {
        for (let r = 0; r < 9; r++) {
          for (let c = 0; c < 9; c++) {
             if (b[r][c] === 0) return false;
             if (!validPlacement(b, r, c, b[r][c])) return false;
          }
        }
        return true;
      }


      function highlightPeers(r, c) {
        cells.forEach((el) =>
          el.classList.remove("highlight-active", "highlight-peer")
        );
        if (r === -1) return;

        cells[r * 9 + c].classList.add("highlight-active");

        for (let i = 0; i < 9; i++) {
          cells[r * 9 + i].classList.add("highlight-peer");
          cells[i * 9 + c].classList.add("highlight-peer");
        }
        const sr = r - (r % 3),
          sc = c - (c % 3);
        for (let i = 0; i < 3; i++)
          for (let j = 0; j < 3; j++) {
            cells[(sr + i) * 9 + (sc + j)].classList.add("highlight-peer");
          }
      }

      function highlight(r, c, cls, val) {
        const el = cells[r * 9 + c];
        el.value = val;
        el.classList.remove("trying", "backtrack");
        if (cls) el.classList.add(cls);
      }

      function setControlsDisabled(disabled) {
        document.getElementById("generateBtn").disabled = disabled;
        document.getElementById("solveBtn").disabled = disabled;
        document.getElementById("skipBtn").disabled = disabled;
        document.getElementById("resetBtn").disabled = disabled;
      }
      
      function formatTime(totalSeconds) {
        const mins = Math.floor(totalSeconds / 60).toString().padStart(2, "0");
        const secs = (totalSeconds % 60).toString().padStart(2, "0");
        return `${mins}:${secs}`;
      }
      
      function startTimer() {
        stopTimer(); 
        secondsElapsed = 0;
        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.textContent = "00:00";
        
        timerInterval = setInterval(() => {
            secondsElapsed++;
            timerDisplay.textContent = formatTime(secondsElapsed);
        }, 1000);
      }
      
      function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
      }
      
      function checkManualWin() {
        const b = readUI();
        if (isBoardValidAndFull(b)) {
            stopTimer();
            triggerConfetti();
            
            const oldBest = userData.bestTimes[currentDifficulty];
            if (!oldBest || secondsElapsed < oldBest) {
                userData.bestTimes[currentDifficulty] = secondsElapsed;
                saveUserData();
                updateStatsDisplay();
                showToast(`New best time for ${currentDifficulty}: ${formatTime(secondsElapsed)}!`);
            } else {
                showToast(`Solved in ${formatTime(secondsElapsed)}!`);
            }
        }
      }
      
      function saveUserData() {
        allUsers[currentUser] = userData;
        localStorage.setItem("sudoku_users", JSON.stringify(allUsers));
      }
      
      function updateStatsDisplay() {
        document.getElementById("bestEasy").textContent = userData.bestTimes.easy 
            ? formatTime(userData.bestTimes.easy) : "N/A";
        document.getElementById("bestMedium").textContent = userData.bestTimes.medium 
            ? formatTime(userData.bestTimes.medium) : "N/A";
        document.getElementById("bestHard").textContent = userData.bestTimes.hard 
            ? formatTime(userData.bestTimes.hard) : "N/A";
      }

      async function visualizeSolve(board) {
        const b = deepCopy(board);
        stopViz = false;

        async function dfs() {
          if (stopViz) return false;
          for (let r = 0; r < 9; r++)
            for (let c = 0; c < 9; c++)
              if (!original[r][c] && b[r][c] === 0) {
                for (let n = 1; n <= 9; n++) {
                  if (stopViz) return false;
                  if (validPlacement(b, r, c, n)) {
                    b[r][c] = n;
                    highlight(r, c, "trying", n);
                    await sleep(
                      speedMap[document.getElementById("speed").value]
                    );
                    if (await dfs()) return true;
                    if (stopViz) return false;
                    b[r][c] = 0;
                    highlight(r, c, "backtrack", "");
                    await sleep(
                      speedMap[document.getElementById("speed").value]
                    );
                  }
                }
                return false;
              }
        return true;
        }
        
        stopTimer(); 
        setControlsDisabled(true);
        const done = await dfs();
        if (done) {
          triggerConfetti();
        } else if (!stopViz) {
          showToast("No valid solution found for this board configuration.");
        }
        setControlsDisabled(false);
      }

      function solveFast(board) {
        const b = deepCopy(board);

        function solveWithOriginal(b) {
          for (let r = 0; r < 9; r++)
            for (let c = 0; c < 9; c++)
              if (!original[r][c] && b[r][c] === 0) {
                for (let n = 1; n <= 9; n++)
                  if (validPlacement(b, r, c, n)) {
                    b[r][c] = n;
                    if (solveWithOriginal(b)) return true;
                    b[r][c] = 0;
                  }
                return false;
              }
          return true;
        }

        stopTimer(); 
        setControlsDisabled(true);
        const ok = solveWithOriginal(b);
        if (ok) {
          for (let r = 0; r < 9; r++)
            for (let c = 0; c < 9; c++)
              if (!original[r][c]) {
                cells[r * 9 + c].value = b[r][c];
                cells[r * 9 + c].classList.add("solved");
              }
          triggerConfetti();
        } else {
          showToast("No valid solution found.");
        }
        setControlsDisabled(false);
      }

      function triggerConfetti() {
        const cv = document.getElementById("confetti"),
          ctx = cv.getContext("2d");
        cv.width = innerWidth;
        cv.height = innerHeight;
        let pcs = [];
        const colors = [
          "#007bff", "#0059b3", "#1e88e5", "#00acc1",
          "#43a047", "#fdd835", "#fb8c00", "#f4511e", "#e53935", "#d81b60",
        ];
        for (let i = 0; i < 150; i++) {
          pcs.push({
            x: Math.random() * cv.width,
            y: -Math.random() * cv.height,
            vx: (Math.random() - 0.5) * 6,
            vy: Math.random() * 6 + 2,
            size: Math.random() * 6 + 4,
            color: colors[Math.floor(Math.random() * colors.length)],
            rot: Math.random() * 360,
            alpha: 1,
          });
        }
        function draw() {
          ctx.clearRect(0, 0, cv.width, cv.height);
          for (const p of pcs) {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.15;
            p.rot += 5;
            p.alpha -= 0.004;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rot * Math.PI) / 180);
            ctx.globalAlpha = Math.max(p.alpha, 0);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
            ctx.restore();
          }
          pcs = pcs.filter((p) => p.alpha > 0);
          if (pcs.length) requestAnimationFrame(draw);
        }
        draw();
      }

      document.getElementById("generateBtn").onclick = async () => {
        setControlsDisabled(true);
        loadUI([]);
        clearMarks();
        currentDifficulty = document.getElementById("difficulty").value; 
        const btn = document.getElementById("generateBtn");
        const oldText = btn.textContent;
        btn.textContent = "Generating...";
        await new Promise((resolve) =>
          setTimeout(async () => {
            const p = await generatePuzzle(currentDifficulty);
            loadUI(p);
            resolve();
          }, 10)
        );
        btn.textContent = oldText;
        setControlsDisabled(false);
        startTimer(); 
      };

      document.getElementById("solveBtn").onclick = async () => {
        const b = readUI();
        if (!validate(b)) return;
        await visualizeSolve(b);
      };

      document.getElementById("skipBtn").onclick = () => {
        const b = readUI();
        if (!validate(b)) return;
        solveFast(b);
      };

      document.getElementById("resetBtn").onclick = () => {
        loadUI([]);
        clearMarks();
        stopTimer(); 
        document.getElementById("timerDisplay").textContent = "00:00"; 
      };

      document.getElementById("stopBtn").onclick = () => {
        stopViz = true;
        setControlsDisabled(false);
      };

      const THEME_KEY = "sudoku_theme";
      const themeBtn = document.getElementById("themeBtn");
      
      function loadTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === "dark") document.body.classList.add("dark");
        themeBtn.textContent = document.body.classList.contains("dark")
          ? "â˜€ï¸"
          : "ðŸŒ™";
      }

      themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        localStorage.setItem(THEME_KEY, isDark ? "dark" : "light");
        themeBtn.textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
      });
      
      // --- App Initialization & Login ---
      
      function showApp(username) {
        currentUser = username;
        localStorage.setItem("sudoku_currentUser", currentUser);
        
        allUsers = JSON.parse(localStorage.getItem("sudoku_users") || "{}");
        userData = allUsers[currentUser] || { bestTimes: { easy: null, medium: null, hard: null } };
        
        document.body.classList.add("loggedIn");
        document.getElementById("userInfo").style.display = "flex";
        document.getElementById("themeBtn").style.display = "block";
        document.getElementById("welcomeMsg").textContent = `Welcome, ${currentUser}!`;
        
        loadTheme();
        updateStatsDisplay();
      }
      
      document.getElementById("loginBtn").addEventListener("click", () => {
        const username = document.getElementById("usernameInput").value.trim();
        if (username) {
            showApp(username);
        } else {
            showToast("Please enter a name.");
        }
      });
      
      // === NEW: Added Enter key listener ===
      document.getElementById("usernameInput").addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
          document.getElementById("loginBtn").click();
        }
      });
      
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("sudoku_currentUser");
        location.reload();
      });
      
      window.addEventListener("DOMContentLoaded", () => {
        const savedUser = localStorage.getItem("sudoku_currentUser");
        if (savedUser) {
            showApp(savedUser);
        }
      });
      
    </script>
  </body>
</html>